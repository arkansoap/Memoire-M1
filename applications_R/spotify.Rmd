---
title: "spotify"
author: "Thibault FUCHEZ"
date: "04/05/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Package

```{r}
library (tidyverse) # collection of packages for data analysis
library(caret) # Classification And REgression Training
library(pROC) # Tools for visualizing, smoothing and comparing ROC.
library(lubridate) # R commands for date-times
library(tidymodels) #  collection of packages for modeling and machine learning using tidyverse principles. pre-process/train/validate
library(MASS) # Modern Applied Statistics with S" for regression and classification
```

# Préparation de la base de données 

## En amont 

On charge la base de donnée. Les variables de types "str" sont recodées en facteurs.

```{r}
spotify <- read.csv("spotify_songs.csv", header = TRUE, sep = ",",stringsAsFactors=T)
```

Etant données qu'il n'y a que 15 valeurs manquantes, on décide de supprimer les individus contenant ces valeurs.

```{r}
sum(is.na(spotify))
spotify = na.omit(spotify)
```
Lignes dupliquées : 

Je ne parviens pas à utiliser la fonction distinct de dplyr, aucune lignes supprimées...
Enlever duplicated par track_name n'est pas une bonne idée car on enlève les reprises et cover. Duplicated garde la première valeur de la liste.


```{r}
spot1 <- spotify[!duplicated(spotify$track_id),]
# spot2 <- spotify
# spot2 %>% distinct(track_id)
# spot3 <- spotify[duplicated(spot2$track_id),]
# spot4 <- spotify[!duplicated(spotify$track_name),]
```

Changement du nom des levels:

```{r}
spot1$key <- recode_factor(spot1$key,
  "0" = "C",
  "1" = "Db",
  "2" = "D",
  "3" = "Eb",
  "4" = "E",
  "5" = "F",
  "6" = "Gb",
  "7" = "G",
  "8" = "Ab",
  "9" = "A",
  "10" = "Bb",
  "11" = "B"
)

spot1$mode <- recode_factor(spot1$mode, "0" = "mineur", "1" = "majeur")
```

recodage de la date / regroupement par tranches :

```{r}
spot1$track_album_release_date <- as.Date(spot1$track_album_release_date , format= "%Y")
spot1<- spot1 %>% mutate(year = year(track_album_release_date))
spot1$years <- cut(spot1$year, breaks = c(1956,2000,2010,2015,2018,2020),
                   diag.lab=0,
                   labels = c("1956-2000","2001-2010",
                              "2011-2015","2016-2018","2019-2020"))
```

Suppression de instrumentalness mal codé : 

```{r}
spot1<-spot1[,-c(7,19)]
```

Recodage de track-popularity / regroupement basse/autres :

```{r}
popularity <- cut(spot1$track_popularity, c(-1,12.5,100))
spot_B=cbind(popularity,spot1)
spot_B<-spot_B[,-5]
spot_B$popularity <- recode_factor(spot_B$popularity,
                                     "(12.5,100]" = "Autre",
                                     "(-1,12.5]" = "basse")
```

On enlève les variables non pertinentes pour la classification : 

```{r}
str(spot_B)
spot_B<-spot_B[,-c(2,3,4,5,6,7,8,10)]
```

## Partitionnement : 

The training and test sets were created using stratiﬁed random sampling.

First, split the training set off:

```{r}
set.seed(42)
split1 <- createDataPartition(spot_B$popularity, p = .7)[[1]]
other <- spot_B[-split1,]
training <- spot_B[ split1,]
```

Now create the evaluation and test sets :

```{r}
set.seed(24)
split2 <- createDataPartition(spot_B$popularity, p = 1/3)[[1]]
evaluation <- other[ split2,]
testing <- other[-split2,]
```

## Normalize/standardize the data :

```{r}
# Estimate preprocessing parameters
preproc.param <- training %>% 
  preProcess(method = c("center", "scale"))
# Transform the data using the estimated parameters
train.transformed <- preproc.param %>% predict(training)
test.transformed <- preproc.param %>% predict(testing)
evaluation.transformed <- preproc.param %>% predict(evaluation)
```

```{r}
# # Determine the predictor names :
# predictors <- names(training)[names(training) != "popularity"]
```

# LDA : Linear discriminant analysis

```{r}
# Fit the model
ModLda <- lda(popularity~., data = train.transformed)
# Make predictions
predLda <- ModLda %>% predict(test.transformed)
# Model accuracy
mean(predLda$class==test.transformed$popularity)
```
